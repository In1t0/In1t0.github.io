<h1 id="Drozer-Tutorial"><a href="#Drozer-Tutorial" class="headerlink" title="Drozer Tutorial"></a>Drozer Tutorial</h1><h2 id="APKs-to-test"><a href="#APKs-to-test" class="headerlink" title="APKs to test"></a>APKs to test</h2><ul>
<li><a href="https://github.com/mwrlabs/drozer/releases/download/2.3.4/sieve.apk" target="_blank" rel="noopener">Sieve</a> (from mrwlabs)</li>
<li><a href="https://payatu.com/wp-content/uploads/2016/01/diva-beta.tar.gz" target="_blank" rel="noopener">DIVA</a></li>
</ul>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><p>Install Drozer Client inside your host. Download it from the <a href="https://github.com/mwrlabs/drozer/releases" target="_blank" rel="noopener">latest releases</a>.</p>
<pre><code class="bash">pip install drozer-2.4.4-py2-none-any.whl
pip install twisted
pip install service_identity
</code></pre>
<p>Download and install drozer APK from the <a href="https://github.com/mwrlabs/drozer/releases" target="_blank" rel="noopener">latest releases</a>. At this moment it is <a href="https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk" target="_blank" rel="noopener">this</a>.</p>
<pre><code class="text">adb install drozer.apk
</code></pre>
<h3 id="Starting-the-Server"><a href="#Starting-the-Server" class="headerlink" title="Starting the Server"></a>Starting the Server</h3><p>Agent is running on port 31415, we need to <a href="https://en.wikipedia.org/wiki/Port_forwarding" target="_blank" rel="noopener">port forward</a> to establish the communication between the Drozer Client and Agent, here is the command to do so:</p>
<pre><code class="text">adb forward tcp:31415 tcp:31415
</code></pre>
<p>Finally, <strong>launch</strong> the <strong>application</strong> and press the bottom “<strong>ON</strong>“</p>
<p><img src="../../../.gitbook/assets/image%20(193).png"></p>
<p>And connect to it:</p>
<pre><code class="text">drozer console connect
</code></pre>
<h2 id="Interesting-Commands"><a href="#Interesting-Commands" class="headerlink" title="Interesting Commands"></a>Interesting Commands</h2><table>
<thead>
<tr>
<th align="left"><strong>Commands</strong></th>
<th align="left"><strong>Description</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Help MODULE</strong></td>
<td align="left">Shows help of the selected module</td>
</tr>
<tr>
<td align="left"><strong>list</strong></td>
<td align="left">Shows a list of all drozer modules that can be executed in the current session. This hides modules that you don’t have appropriate permissions to run.</td>
</tr>
<tr>
<td align="left"><strong>shell</strong></td>
<td align="left">Start an interactive Linux shell on the device, in the context of the Agent.</td>
</tr>
<tr>
<td align="left"><strong>clean</strong></td>
<td align="left">Remove temporary files stored by drozer on the Android device.</td>
</tr>
<tr>
<td align="left"><strong>load</strong></td>
<td align="left">Load a file containing drozer commands and execute them in sequence.</td>
</tr>
<tr>
<td align="left"><strong>module</strong></td>
<td align="left">Find and install additional drozer modules from the Internet.</td>
</tr>
<tr>
<td align="left"><strong>unset</strong></td>
<td align="left">Remove a named variable that drozer passes to any Linux shells that it spawns.</td>
</tr>
<tr>
<td align="left"><strong>set</strong></td>
<td align="left">Stores a value in a variable that will be passed as an environmental variable to any Linux shells spawned by drozer.</td>
</tr>
<tr>
<td align="left"><strong>shell</strong></td>
<td align="left">Start an interactive Linux shell on the device, in the context of the Agent</td>
</tr>
<tr>
<td align="left"><strong>run MODULE</strong></td>
<td align="left">Execute a drozer module</td>
</tr>
<tr>
<td align="left"><strong>exploit</strong></td>
<td align="left">Drozer can create exploits to execute in the decide. <code>drozer exploit list</code></td>
</tr>
<tr>
<td align="left"><strong>payload</strong></td>
<td align="left">The exploits need a payload. <code>drozer payload list</code></td>
</tr>
</tbody></table>
<h3 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h3><p>Find the <strong>name</strong> of the package filtering by part of the name:</p>
<pre><code class="text">dz&gt; run app.package.list -f sieve  
com.mwr.example.sieve
</code></pre>
<p><strong>Basic Information</strong> of the package:</p>
<pre><code class="text">dz&gt; run app.package.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
Process Name: com.mwr.example.sieve
Version: 1.0
Data Directory: /data/data/com.mwr.example.sieve
APK Path: /data/app/com.mwr.example.sieve-2.apk
UID: 10056
GID: [1028, 1015, 3003]
Shared Libraries: null
Shared User ID: null
Uses Permissions:
 - android.permission.READ_EXTERNAL_STORAGE
 - android.permission.WRITE_EXTERNAL_STORAGE
 - android.permission.INTERNET
Defines Permissions:
 - com.mwr.example.sieve.READ_KEYS
 - com.mwr.example.sieve.WRITE_KEYS
</code></pre>
<p>Read <strong>Manifest</strong>:</p>
<pre><code class="text">run.package.manifest jakhar.aseem.diva
</code></pre>
<p><strong>Attack surface</strong> of the package:</p>
<pre><code class="text">dz&gt; run app.package.attacksurface com.mwr.example.sieve
Attack Surface:
 3 activities exported
 0 broadcast receivers exported
 2 content providers exported
 2 services exported
 is debuggable
</code></pre>
<ul>
<li><strong>Activities</strong>: Maybe you can start an activity and bypass some kind of authorization that should be prevent you from launching it.</li>
<li><strong>Content providers</strong>: Maybe you can access private dato or exploit some vulnerability (SQL Injection or Path Traversal).</li>
<li><strong>Services</strong>:</li>
<li><strong>is debuggable</strong>: <a href="./#is-debuggeable">Learn more</a></li>
</ul>
<h3 id="Activities"><a href="#Activities" class="headerlink" title="Activities"></a>Activities</h3><p>An exported activity  component’s “android:exported” value is set to <strong>“true”</strong> in the AndroidManifest.xml file:</p>
<pre><code class="markup">&lt;activity android:name=&quot;com.my.app.Initial&quot; android:exported=&quot;true&quot;&gt;
&lt;/activity&gt;
</code></pre>
<p><strong>List exported activities</strong>:</p>
<pre><code class="text">dz&gt; run app.activity.info -a com.mwr.example.sieve
Package: com.mwr.example.sieve
 com.mwr.example.sieve.FileSelectActivity
 com.mwr.example.sieve.MainLoginActivity
 com.mwr.example.sieve.PWList
</code></pre>
<p><strong>Start activity</strong>:</p>
<p>Maybe you can start an activity and bypass some kind of authorization that should be prevent you from launching it.</p>
<pre><code class="text">dz&gt; run app.activity.start --component com.mwr.example.sieve com.mwr.example.sieve.PWList
</code></pre>
<p>You can also start an exported activity from <strong>adb</strong>:</p>
<ul>
<li>PackageName is com.example.demo</li>
<li>Exported ActivityName is com.example.test.MainActivity</li>
</ul>
<pre><code class="text">adb shell am start -n com.example.demo/com.example.test.MainActivity
</code></pre>
<h3 id="Content-Providers"><a href="#Content-Providers" class="headerlink" title="Content Providers"></a>Content Providers</h3><p>This post was so big to be here so <strong>you can</strong> <a href="exploiting-content-providers.md"><strong>access it in its own page here</strong></a>.</p>
<h3 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h3><p>A exported service is declared inside the Manifest.xml:</p>
<pre><code class="markup">&lt;service android:name=&quot;.AuthService&quot; android:exported=&quot;true&quot; android:process=&quot;:remote&quot;/&gt;
</code></pre>
<p>Inside the code <strong>check</strong> for the **<code>handleMessage</code>**function which will <strong>receive</strong> the <strong>message</strong>:</p>
<p><img src="../../../.gitbook/assets/image%20(225).png"></p>
<h4 id="List-service"><a href="#List-service" class="headerlink" title="List service"></a>List service</h4><pre><code class="text">dz&gt; run app.service.info -a com.mwr.example.sieve 
Package: com.mwr.example.sieve
  com.mwr.example.sieve.AuthService
    Permission: null
  com.mwr.example.sieve.CryptoService
    Permission: null
</code></pre>
<h4 id="Interact-with-a-service"><a href="#Interact-with-a-service" class="headerlink" title="Interact with a service"></a><strong>Interact</strong> with a service</h4><pre><code class="text">app.service.send            Send a Message to a service, and display the reply  
app.service.start           Start Service                                       
app.service.stop            Stop Service
</code></pre>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><p>Take a look to the <strong>drozer</strong> help for <code>app.service.send</code>:</p>
<p><img src="../../../.gitbook/assets/image%20(30).png"></p>
<p>Note that you will be sending first the data inside “<em>msg.what</em>“, then “<em>msg.arg1</em>“ and “<em>msg.arg2</em>“, you should check inside the code <strong>which information is being used</strong> and where.<br>Using the <code>--extra</code> option you can send something interpreted by “<em>msg.replyTo”</em>, and using <code>--bundle-as-obj</code> you create and object with the provided details.</p>
<p>In the following example:</p>
<ul>
<li><code>what == 2354</code></li>
<li><code>arg1 == 9234</code></li>
<li><code>arg2 == 1</code></li>
<li><code>replyTo == object(string com.mwr.example.sieve.PIN 1337)</code></li>
</ul>
<pre><code class="text">run app.service.send com.mwr.example.sieve com.mwr.example.sieve.AuthService --msg 2354 9234 1 --extra string com.mwr.example.sieve.PIN 1337 --bundle-as-obj
</code></pre>
<p><img src="../../../.gitbook/assets/image%20(293).png"></p>
<h3 id="Broadcast-Receivers"><a href="#Broadcast-Receivers" class="headerlink" title="Broadcast Receivers"></a>Broadcast Receivers</h3><p>Android apps can send or receive broadcast messages from the Android system and other Android apps, similar to the <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern" target="_blank" rel="noopener">publish-subscribe</a> design pattern. These broadcasts are sent when an event of interest occurs. For example, the Android system sends broadcasts when various system events occur, such as when the system boots up or the device starts charging. Apps can also send custom broadcasts, for example, to notify other apps of something that they might be interested in (for example, some new data has been downloaded).</p>
<p>Apps can register to receive specific broadcasts. When a broadcast is sent, the system automatically routes broadcasts to apps that have subscribed to receive that particular type of broadcast.</p>
<p>This could appear inside the Manifest.xml file:</p>
<pre><code class="markup">&lt;receiver android:name=&quot;.MyBroadcastReceiver&quot;  android:exported=&quot;true&quot;&gt;
    &lt;intent-filter&gt;
        &lt;action android:name=&quot;android.intent.action.BOOT_COMPLETED&quot;/&gt;
        &lt;action android:name=&quot;android.intent.action.INPUT_METHOD_CHANGED&quot; /&gt;
    &lt;/intent-filter&gt;
&lt;/receiver&gt;
</code></pre>
<p>From: <a href="https://developer.android.com/guide/components/broadcasts" target="_blank" rel="noopener">https://developer.android.com/guide/components/broadcasts</a></p>
<p>After discovering this Broadcast Receivers you should <strong>check the code</strong> of them. Pay special attention to the **<code>onReceive</code>**function as it will be handling the messages received.</p>
<h4 id="Detect-all-broadcast-receivers"><a href="#Detect-all-broadcast-receivers" class="headerlink" title="Detect all broadcast receivers"></a><strong>Detect all</strong> broadcast receivers</h4><pre><code class="bash">run app.broadcast.info #Detects all
</code></pre>
<h4 id="Check-broadcast-receivers-of-an-app"><a href="#Check-broadcast-receivers-of-an-app" class="headerlink" title="Check broadcast receivers of an app"></a>Check broadcast receivers of an app</h4><pre><code class="bash">#Check one negative
run app.broadcast.info -a jakhar.aseem.diva
Package: jakhar.aseem.diva
  No matching receivers.

# Check one positive
run app.broadcast.info -a com.google.android.youtube
Package: com.google.android.youtube
  com.google.android.libraries.youtube.player.PlayerUiModule$LegacyMediaButtonIntentReceiver
    Permission: null
  com.google.android.apps.youtube.app.common.notification.GcmBroadcastReceiver
    Permission: com.google.android.c2dm.permission.SEND
  com.google.android.apps.youtube.app.PackageReplacedReceiver
    Permission: null
  com.google.android.libraries.youtube.account.AccountsChangedReceiver
    Permission: null
  com.google.android.apps.youtube.app.application.system.LocaleUpdatedReceiver
    Permission: null
</code></pre>
<h4 id="Broadcast-Interactions"><a href="#Broadcast-Interactions" class="headerlink" title="Broadcast Interactions"></a>Broadcast <strong>Interactions</strong></h4><pre><code class="text">app.broadcast.info          Get information about broadcast receivers           
app.broadcast.send          Send broadcast using an intent                      
app.broadcast.sniff         Register a broadcast receiver that can sniff particular intents
</code></pre>
<h4 id="Send-a-message"><a href="#Send-a-message" class="headerlink" title="Send a message"></a>Send a message</h4><p>In this example abusing the <a href="https://github.com/linkedin/qark/blob/master/tests/goatdroid.apk" target="_blank" rel="noopener">FourGoats apk</a> Content Provider you can <strong>send an arbitrary SMS</strong> any non-premium destination <strong>without asking</strong> the user for permission.</p>
<p><img src="../../../.gitbook/assets/image%20(237).png"></p>
<p><img src="../../../.gitbook/assets/image%20(110).png"></p>
<p>If you read the code, the parameters “<em>phoneNumber</em>“ and “<em>message</em>“ must be sent to the Content Provider.</p>
<pre><code class="text">run app.broadcast.send --action org.owasp.goatdroid.fourgoats.SOCIAL_SMS --component org.owasp.goatdroid.fourgoats.broadcastreceivers SendSMSNowReceiver --extra string phoneNumber 123456789 --extra string message &quot;Hello mate!&quot;
</code></pre>
<h3 id="Is-debuggeable"><a href="#Is-debuggeable" class="headerlink" title="Is debuggeable"></a>Is debuggeable</h3><p>A prodduction APK should never be debuggeable.<br>This mean that you can <strong>attach java debugger</strong> to the running application, inspect it in run time, set breakpoints, go step by step, gather variable values and even change them.<a href="../exploiting-a-debuggeable-applciation.md"> InfoSec institute has an excellent article</a> on digging deeper when you application is debuggable and injecting runtime code. </p>
<p>When an application is debuggable, it will appear in the Manifest:</p>
<pre><code class="text">&lt;application theme=&quot;@2131296387&quot; debuggable=&quot;true&quot;
</code></pre>
<p>You can find all debuggeable applications with <strong>Drozer</strong>:</p>
<pre><code class="text">run app.package.debuggable
</code></pre>
<h2 id="Tutorials"><a href="#Tutorials" class="headerlink" title="Tutorials"></a>Tutorials</h2><ul>
<li><a href="https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref" target="_blank" rel="noopener">https://resources.infosecinstitute.com/android-penetration-tools-walkthrough-series-drozer/#gref</a></li>
<li><a href="http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/" target="_blank" rel="noopener">http://mobiletools.mwrinfosecurity.com/Using-Drozer-for-application-security-assessments/</a></li>
</ul>
<h2 id="More-info"><a href="#More-info" class="headerlink" title="More info"></a>More info</h2><ul>
<li><a href="https://blog.dixitaditya.com/android-pentesting-cheatsheet/" target="_blank" rel="noopener">https://blog.dixitaditya.com/android-pentesting-cheatsheet/</a></li>
</ul>
